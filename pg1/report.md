# System Calls of Copying

## Running Program and it's output

When we test and monitor the system calls of copying files from /tmp/tmp/.1f9OCezipI to /tmp/tmp.6Wnc80Pke9 by using the following command:

    LD_LIBRARY_PATH=. strace -f -o ~/test1-strace.log java -classpath ".:../lib/commons-cli-1.2.jar:/usr/lib/jvm/jdk1.7.0_06/jre/lib" Copy -m 1 -f /tmp/tmp.1f9OCezipI -t /tmp/tmp.6Wnc80Pke9

The running result is:

    Copied 46 bytes, from /tmp/tmp.1f9OCezipI to /tmp/tmp.6Wnc80Pke9
    Time used in copy operation is 50666735 nano seconds

And we also get the file `test1-strace.log` full of the outputs of command `strace`, which can tell us the system calls during the process. Actually, most of the system calls are generated by JVM. We only focus on the part of copy process.

## `strace` Output Analysis

Here is a piece of record that we care about:

    5353  open("/tmp/tmp.1f9OCezipI", O_RDONLY|O_LARGEFILE) = 5
    5353  fstat64(5, {st_mode=S_IFREG|0600, st_size=46, ...}) = 0
    5353  fcntl64(5, F_GETFD)               = 0
    5353  fcntl64(5, F_SETFD, FD_CLOEXEC)   = 0
    5353  open("/tmp/tmp.6Wnc80Pke9", O_WRONLY|O_CREAT|O_TRUNC|O_LARGEFILE, 0666) = 6
    5353  fstat64(6, {st_mode=S_IFREG|0644, st_size=0, ...}) = 0
    5353  fcntl64(6, F_GETFD)               = 0
    5353  fcntl64(6, F_SETFD, FD_CLOEXEC)   = 0
    5353  read(5, "Hello World\nHello Java\nHello Ope"..., 1024) = 46
    5360  <... futex resumed> )             = -1 ETIMEDOUT (Connection timed out)
    5360  futex(0x9262c28, FUTEX_WAKE_PRIVATE, 1) = 0
    5360  gettimeofday({1346122455, 887732}, NULL) = 0
    5360  clock_gettime(CLOCK_MONOTONIC, {30979, 424506731}) = 0
    5360  gettimeofday({1346122455, 887781}, NULL) = 0
    5360  clock_gettime(CLOCK_REALTIME, {1346122455, 887806081}) = 0
    5360  futex(0x9262c44, FUTEX_WAIT_PRIVATE, 1, {0, 49974919} <unfinished ...>
    5353  write(6, "Hello World\nHello Java\nHello Ope"..., 46) = 46
    5353  read(5, "", 1024)                 = 0
    5353  close(5)                          = 0
    5353  close(6)                          = 0

In the record we can see the 4 main system calls about file management: 

`open()`: system call to open a file

    SYNOPSIS 
         #include <sys/types.h> 
         #include <sys/stat.h> 
         #include <fcntl.h> 
    
         int open (const char *path, int oflag); 
    
    DESCRIPTION 
         path points to a path name naming a file.  open opens a file descriptor 
         for the named file and sets the file status flags according to the value 
         of oflag. 
    
         O_RDONLY 
                Open for reading only. 
    
         O_WRONLY 
                Open for writing only. 
    
         O_RDWR Open for reading and writing. 


`read()`: read data from a file opened for reading

    SYNOPSIS 
         #include <unistd.h> 
         ssize_t read(int fildes, void *buf, size_t nbyte); 
    
    DESCRIPTION 
         read attempts to read nbyte bytes from the file associated with fildes 
         into the buffer pointed to by buf.  If nbyte is zero, read returns zero 
         and has no other results. 


`write()`: write data to a file opened for writing

    SYNOPSIS 
         #include <unistd.h> 
         ssize_t write(int fildes, const void *buf, size_t nbyte); 
    
    DESCRIPTION 
         write attempts to write nbyte bytes from the buffer pointed to by buf to 
         the file associated with fildes.  If nbyte is zero and the file is a 
         regular file, write returns zero and has no other results.  fildes is a 
         file descriptor. 


`close()`: sstem call to close a file

    SYNOPSIS 
         #include <unistd.h> 
         int close(int fildes); 
    
    DESCRIPTION 
         close closes the file descriptor indicated by fildes. 

Also we can see `fstat64()` returning information about a file and `fcntl64()` manipulate the descriptor of a file.


By getting familar with these file system calls, we can figure out the main process of copying files:

 1. Open the file to be read, and check the file information at the same time.
 2. Open or create the file to be writen.
 3. Read part of the first file and write the part in the second file.
 4. When the read() return value zero, that means it has got the end of the file.
 5. Close both the two files to finish the copy process.
